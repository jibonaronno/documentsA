<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <title>PDA 001 Getting Started ti Linux SDK</title>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <!-- BEGIN syntax highlighter -->
    <script type="text/javascript" src="sh/shCore.js"></script>
    <script type="text/javascript" src="sh/shBrushJScript.js"></script>
    <link type="text/css" rel="stylesheet" href="sh/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="sh/shThemeDefault.css"/>
    <link href="https://fonts.googleapis.com/css?family=Gruppo" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <script type="text/javascript">
      SyntaxHighlighter.all();
    </script>
    <!-- END syntax highlighter -->

    <link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="linuxsetup.css">
  </head>
  <body>
  
<div style="padding: 20px;font-size: 24px; line-height: 40px">
<div class="title_b">Startup Document Links</div>

<!-- SHOW HIDE START 001  -->

<style type="text/css">
div[id=div-001] {
  display: none;
}
  input[id=toggle-001]:checked ~ div[id=div-001] {
    display: block;
    }
</style>

<h2><label for="toggle-001">ti Linux SDK 05_02_00_10 </label></h2>
<input type="checkbox" id="toggle-001" style="display: none;">

<div id="div-001">
    <tab></tab>

    From the instructions we can make our custom app by just <code>make</code> command in the Ubuntu VM. The files are already placed at several locations.
    All the locations are explained below. We can start development directly in the VM. We are trying to understand the locations of the required resources here.
    Also the ti sdk documentation stated some requirements which is already done in the Ubuntu VM. The links to ti sdk documents and requirements are mentioned below.
    
    <br>

    check 1.1.2 : <a href="https://software-dl.ti.com/processor-sdk-linux/esd/docs/05_02_00_10/linux/Overview_Getting_Started_Guide.html#id21">1.1.2. Windows SD Card Creation Guide</a> <br>
    <img alt="NO IMAGE" width="50%" src="img/img002.jpg"><br />

    Reference <a href="https://software-dl.ti.com/processor-sdk-linux/esd/docs/05_02_00_10/linux/Overview_Getting_Started_Guide.html#id21"> 1.1.3. Download and Install the SDK </a><br />
    <img alt="NO IMAGE" width="50%" src="img/img001.jpg"><br />

    These documents statements some requirement before ti Linux development. <br>
    <pp>The SDK folder is in</pp><p5>/opt/ti-processor-sdk-linux-rt-am57xx-evm-05.02.00.10/</p5> Location in Ubuntu VM. <br>
    <pp>The Project is in</pp><p5>/home/taki/LocalUnit</p5> in Ubuntu VM. <br>
    <br>
    <div class="title_b">Makefile</div>
    The <p3> makefile </p3> inside <code>/home/taki/LocalUnit/sdk</code> is for build the project. This makefile includes the sdk location as  <br>

    <img alt="NO IMAGE" width="80%" src="img/img003.jpg"><br />
    Also see the BSP location <code>/sanion/HUR-IED/bsp/linux-rt-4.14.79</code><br>
    
    Also check the following locations that indicates to inside bsp locations. <br>
    <img alt="NO IMAGE" width="50%" src="img/img004.jpg"><br />

    

<pp>Following fstab setup is present on first LU system. Note the rw flag.</pp>
    <pre class="brush:js;">
      SLU-IED:~$ cat /etc/fstab
# stock fstab - you probably want to override this with a machine specific one

/dev/root            /                    auto       defaults,rw           1  1
proc                 /proc                proc       defaults              0  0
devpts               /dev/pts             devpts     mode=0620,gid=5       0  0
usbdevfs             /proc/bus/usb        usbdevfs   noauto                0  0
tmpfs                /run                 tmpfs      mode=0755,nodev,nosuid,strictatime 0  0
tmpfs                /var/volatile        tmpfs      defaults,size=50M     0  0
tmpfs                /media/ram           tmpfs      defaults,size=16M     0  0
#tmpfs               /data/COMTRADE               tmpfs      defaults,size=100M    0  0

# uncomment this if your device has a SD/MMC/Transflash slot
/dev/mmcblk0p2       /upgrade             ext4       defaults,sync,noauto  1  2
/dev/mmcblk0p3       /data                ext4       defaults,sync,noauto  1  2

    </pre><br /><br />
    <br><br>
</div>
<!-- SHOW HIDE SEND 001  -->

<!-- SHOW HIDE START 002  -->
<style type="text/css">
  div[id=div-002] {
    display: none;
  }
    input[id=toggle-002]:checked ~ div[id=div-002] {
      display: block;
      }
  </style>
  
  <h2><label for="toggle-002">Setting up Ubuntu Linux Host. Install SDK Toolchain & more</label></h2>
  <input type="checkbox" id="toggle-002" style="display: none;">
  
  <div id="div-002">
    Follow this <a href="https://software-dl.ti.com/processor-sdk-linux/esd/docs/05_02_00_10/linux/Overview_Getting_Started_Guide.html#id21"> 1.1.3. Download and Install the SDK </a>
    to setup an environment to develop ti processor apps. <br>
    <img alt="NO IMAGE" width="50%" src="img/img001.jpg"><br />
    After download <code>ti-processor-sdk-linux-rt-am57xx-evm-08_02_01_00-Linux-x86-Install.bin</code> file 
    we have to run it in Ubuntu. 
    <br>
    After installing the binary: <br>
    Following article at <a href="https://software-dl.ti.com/processor-sdk-linux/esd/docs/05_02_00_10/linux/Overview_Getting_Started_Guide.html#gcc-toolchain">GCC</a> <code>1.1.7 GCC Toolchain</code> states various folder locations of the toolchain. <br>
      <img alt="NO IMAGE" width="50%" src="img/img008.jpg"><br />

      It looks like <p5>ti-processor-linux-..../linux-devkit/sysroots/x86_64-arago-linux/</p5> location has the cross compiler tools. <br>
      <img alt="NO IMAGE" width="50%" src="img/img009.jpg"><br />

    <p5>Cross Tools</p5><pp>Pre Built Libraries</pp><br>
    The pre built libraries can be found in : <br>
    <p3> &lt;SDK DIR&gt;/linux-devkit/sysroots/armv7at2hf-neon-linux-gnueabi/usr/lib </p3> location. And the header files are in <p3>
      &lt;SDK DIR&gt;/linux-dev-kit/sysroots/armv7at2hf-neon-linux-gnueabi/usr/include</p3> location. <br><br>

    Later I compiled a helloworld.c by using following command. <br>
    <code>~/ti-processor-sdk...../linux-devkit/sysroots/x86_64-arago..../usr/bin/arm-none-linux-gnueabihf-gcc hello.c -o hello</code> <br>
    There is also a pthread example is in <p3>1.1.7 GCC Toolchain</p3> section. <br>

    <pre class="brush:js;">
      #include <unistd.h>;
      #include <sys/types.h>;
      #include <errno.h>;
      #include <stdio.h>;
      #include <stdlib.h>;
      #include <pthread.h>;
      #include <string.h>;
      
      int print_message_function(void *ptr);
      
      /* struct to hold data to be passed to a thread
      this shows how multiple data items can be passed to a thread */
      typedef struct str_thdata
      {
          int thread_no;
          char message[100];
      } thdata;
      
      int main(int argc, void **argv)
      {
          pthread_t thread1, thread2;
          thdata data1, data2;
      
          data1.thread_no = 1;
          strcpy(data1.message, "Hello!");
      
          data2.thread_no = 2;
          strcpy(data2.message, "Hi!");
      
          pthread_create (&thread1, NULL, (void *) &print_message_function, (void *) &data1);
          pthread_create (&thread2, NULL, (void *) &print_message_function, (void *) &data2);
      
          pthread_join(thread1, NULL);
          pthread_join(thread2, NULL);
      
          exit(0);
      }
      
      int print_message_function ( void *ptr )
      {
          thdata *data;
          data = (thdata *) ptr;  /* type cast to a pointer to thdata */
      
          /* do the work */
          printf("Thread %d says%s \n", data->thread_no, data->message);
      
          return 0;
      }
    </pre><br /><br />
    <p3> Another code with loops: </p3><br>
    <pre class="brush:js;">
      #include <unistd.h>
      #include <sys/types.h>
      #include <errno.h>
      #include <stdio.h>
      #include <stdlib.h>
      #include <pthread.h>
      #include <string.h>
      
      int printmsgfunc(void *func);
      
      typedef struct str_thdata
      {
        int thread_no;
        char msg[120];
      
      }thdata;
      
      int main(int argc, void **argv)
      {
        pthread_t thread1, thread2;
        thdata data1, data2;
      
        data1.thread_no = 1;
        strcpy(data1.msg, "This Text from T1");
      
        data2.thread_no = 2;
        strcpy(data2.msg, "Second Thread MSG T2");
      
        pthread_create(&thread1, NULL, (void *)&printmsgfunc, (void *)&data1);
        pthread_create(&thread2, NULL, (void *)&printmsgfunc, (void *)&data2);
      
        pthread_join(thread1, NULL);
        pthread_join(thread2, NULL);
      
        while(1)
        {
          ;
        }
      
        exit(0);
      }
      
      int printmsgfunc(void *ptr)
      {
        thdata *data;
        data = (thdata *)ptr;
      
        while(1)
        {
          printf("Thread %d Out %s \n", data->thread_no, data->msg);
          sleep(1);
        }
        return 0;
      }        
    </pre><br /><br />
    <pp>Command</pp> <code>~/ti-processor-sdk...../linux-devkit/sysroots/x86_64-arago..../usr/bin/arm-none-linux-gnueabihf-gcc threadxA.c -o threadxA</code> <br>

  </div>
  <!-- SHOW HIDE SEND 002  -->

<!-- SHOW HIDE START 002A  -->
<style type="text/css">
  div[id=div-002A] {
    display: none;
  }
    input[id=toggle-002A]:checked ~ div[id=div-002A] {
      display: block;
      }
  </style>
  
  <h2><label for="toggle-002A">1.2. Building the SDK <a href="https://software-dl.ti.com/processor-sdk-linux/esd/docs/05_02_00_10/linux/Overview_Building_the_SDK.html#building-the-sdk">Link</a> </label></h2>
  <input type="checkbox" id="toggle-002A" style="display: none;">
  
  <div id="div-002A">
      <tab></tab>
      Though I am not sure why another process of building SDK is required. <br>
      <img alt="NO IMAGE" width="50%" src="img/img010.jpg"><br />
      So there are a number of tools that needed to install or download. <br>
      <code>$ sudo apt-get install git build-essential python diffstat texinfo gawk chrpath dos2unix wget unzip socat doxygen libc6:i386 libncurses5:i386 libstdc++6:i386 libz1:i386</code> <br>

      <div class="title_b">Cross-Compile Toolchain</div>
      <pre class="brush:js;">
      Run the following commands to install the Linaro Toolchain. <br>
      $ wget https://releases.linaro.org/components/toolchain/binaries/7.2-2017.11/arm-linux-gnueabihf/gcc-linaro-7.2.1-2017.11-x86_64_arm-linux-gnueabihf.tar.xz
      $ tar -Jxvf gcc-linaro-7.2.1-2017.11-x86_64_arm-linux-gnueabihf.tar.xz -C $HOME
      $ wget https://releases.linaro.org/components/toolchain/binaries/7.2-2017.11/aarch64-linux-gnu/gcc-linaro-7.2.1-2017.11-x86_64_aarch64-linux-gnu.tar.xz
      $ tar -Jxvf gcc-linaro-7.2.1-2017.11-x86_64_aarch64-linux-gnu.tar.xz -C $HOME
      </pre>



      <br>
  </div>
  <!-- SHOW HIDE END 002A  -->

<!-- SHOW HIDE START 002B  -->
<style type="text/css">
  div[id=div-002B] {
    display: none;
  }
    input[id=toggle-002B]:checked ~ div[id=div-002B] {
      display: block;
      }
  </style>
  
  <h2><label for="toggle-002B"> Cross Tools According Hand Notes </label></h2>
  <input type="checkbox" id="toggle-002B" style="display: none;">
  
  <div id="div-002B">
      <tab></tab>
      <pp>Cross tool installation practice hand notes</pp><br>
      <img alt="NO IMAGE" width="50%" src="img/img014.jpg"><img alt="NO IMAGE" width="50%" src="img/img015.jpg"><br />
  </div>

<!-- SHOW HIDE END 002B -->

<!-- SHOW HIDE START 003  -->
<style type="text/css">
  div[id=div-003] {
    display: none;
  }
    input[id=toggle-003]:checked ~ div[id=div-003] {
      display: block;
      }
  </style>
  
  <h2><label for="toggle-003">NFS Mount</label></h2>
  <input type="checkbox" id="toggle-003" style="display: none;">
  
  <div id="div-003">

    <div class="title_b">Following NFS folder /var/nfs/general is created in the newly created Ubuntu VM. It is /nfs_resource in the older VM </div>
      <tab></tab>
      Making a NFS from online guide did not goes well. Install by <code>sudo apt install nfs-kernel-server</code>.
      edit <p5>/etc/exports</p5> for setting up the folder for nfs. <br>
      <code>/var/nfs/general  *(rw,nohide,insecure,no_subtree_check,no_root_squash)</code> <br>
      Create a folder <p5>/var/nfs/general</p5> . After any change to /etc/exports restart the service 
      as <code>sudo systemctl restart nfs-kernel-server</code> . You also need to setup ufw firewall 
      commands as <br>
      <code>sudo ufw allow from 203.0.113.24 to any port nfs</code> . <br> <br>

      In the client create a folder (my folder is general) use command <code>mount 192.168.10.16:/var/nfs/general general</code> <br>

      <pp>Hand Written Documents                                                          .</pp><br>
      <img alt="NO IMAGE" width="50%" src="img/img016.jpg"><br />
      This <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nfs-mount-on-ubuntu-18-04">docs</a> and <a href="https://linuxhint.com/install-and-configure-nfs-server-ubuntu-22-04/">docs</a> could help a small . 

      <br>
  </div>
  <!-- SHOW HIDE SEND 003  -->

<!-- SHOW HIDE START 004  -->
<style type="text/css">
  div[id=div-004] {
    display: none;
  }
    input[id=toggle-004]:checked ~ div[id=div-004] {
      display: block;
      }
  </style>
  
  <h2><label for="toggle-004">various Examples From Web A</label></h2>
  <input type="checkbox" id="toggle-004" style="display: none;">
  
  <div id="div-004">
      <tab></tab>
      Write a C code that eliminates <code> Ctrl + c </code> signal. <br>
      <img alt="NO IMAGE" width="50%" src="img/img005.jpg"><br />
      <img alt="NO IMAGE" width="50%" src="img/img006.jpg"><br />
      We may usually want to use ncurses <br>
      <img alt="NO IMAGE" width="50%" src="img/img007.jpg"><br />
      <br>
  </div>
  <!-- SHOW HIDE SEND 004  -->

<!-- SHOW HIDE START 005  -->
<style type="text/css">
  div[id=div-005] {
    display: none;
  }
    input[id=toggle-005]:checked ~ div[id=div-005] {
      display: block;
      }
  </style>
  
  <h2><label for="toggle-005">Using Micro Modbus Library with PDA LU software</label></h2>
  <input type="checkbox" id="toggle-005" style="display: none;">
  
  <div id="div-005">
      <tab></tab>
      <p5>Step 1</p5><pp>Cross Compile MicroModbus Library</pp> <br>
      Modify Makefile to crosscompile the library. <br>

      <pre class="brush:js;">

        ### BUILD ###

        export TI_SDK_PATH=/opt/ti-processor-sdk-linux-rt-am57xx-evm-05.02.00.10
        
        TOOL_PREFIX := arm-linux-gnueabihf-
        CC := $(TOOL_PREFIX)gcc
        LD := $(TOOL_PREFIX)ld
        STRIP := $(TOOL_PREFIX)strip
        
        LINUX_DEVKIT_PATH := $(TI_SDK_PATH)/linux-devkit
        
        CC := $(TOOL_PREFIX)gcc
        CPP := $(TOOL_PREFIX)cpp
        LD := $(TOOL_PREFIX)ld
        STRIP := $(TOOL_PREFIX)strip
        
        #CC=gcc
        #CPP=g++
        
        #CFLAGS= -Wall -O2 -g -D_REENTRANT -fPIC
        #CFLAGS= -Wall -O2 -g -D_REENTRANT -fPIC -DDEBUG
        #CFLAGS= -Wall -O2 -fno-defer-pop -g -D_REENTRANT -fPIC -DDEBUG
        CFLAGS= -Wall -g -D_REENTRANT -fPIC -DDEBUG
        #CFLAGS= -Wall -g -D_REENTRANT -fPIC -mtune=generic
        #CFLAGS= -Wall -g -D_REENTRANT -fPIC -m486
        #CFLAGS= -Wall -g -D_REENTRANT -fPIC
        CPPFLAGS=$(CFLAGS)
        
        LIB_OBJS=modbus.o modbus_serial.o modbus_asc.o modbus_rtu.o modbus_tcp.o 
        
        all: libmodbus.so libmodbus.a example example2 
        #	mb_read mb_analyzer mb_responder
        #     example example2 
        
        clean:
          rm -f example example.o example2 example2.o mb_read mb_read.o mb_analyzer mb_analyzer.o mb_responder mb_responder.o $(LIB_OBJS) libmodbus.so libmodbus.a
        
        
        
        ### C Library and archive
        
        # a shared library
        # if you want this, copy the library to some system-wide library directory and run ldconfig
        libmodbus.so: $(LIB_OBJS)
          $(CC) -shared -Wl,-soname,$@ -o $@ $(LIB_OBJS)
        
        # a "static" library, also known as an "archive"
        libmodbus.a: $(LIB_OBJS)
          ar cruv $@ $(LIB_OBJS)
          ranlib $@
        
        # the rest gets taken care of by the implicit rule of .c.o
        
        
        
        
        ### INSTALL ###
        
        MY_LIBDIR=/usr/lib
        MY_INCLDIR=/usr/include
        
        MY_LIBS=libmodbus.so libmodbus.a
        MY_HEADERS=modbus_serial.h modbus_asc.h modbus_rtu.h modbus_tcp.h modbus.h modbus_list.h
        
        install: $(MY_LIBS)
          cp -dpR $(MY_LIBS) $(MY_LIBDIR)/
          cp $(MY_HEADERS) $(MY_INCLDIR)/
        
        uninstall:
          for file in $(MY_LIBS); do rm $(MY_LIBDIR)/$$file; done
          for file in $(MY_HEADERS); do rm $(MY_INCLDIR)/$$file; done
        
        ### EXAMPLES ###
        
        #example.o: example.c
        #	$(CC) $(CFLAGS) -c -o $@ $<
        
        example: example.o libmodbus.a
          $(CC) -o $@ example.o -L. -lmodbus -lpthread
        
        example2: example2.o libmodbus.a
          $(CC) -o $@ example2.o -L. -lmodbus -lpthread
        
        mb_read: mb_read.o
          $(CPP) -o $@ -L. -lmodbus -lpthread -lpcre $<
        
        mb_analyzer: mb_analyzer.o
          $(CPP) -o $@ -L. -lmodbus -lpthread -lpcre $<
        
        mb_responder: mb_responder.o
          $(CPP) -o $@ -L. -lmodbus -lpthread -lpcre $<
        
        
      </pre><br />

      <img alt="NO IMAGE" width="70%" src="img/img011.jpg"><br />

      <p5>Step 2</p5><pp>Receive data over modbus master - slave</pp> <br>

      In <p3>MTrMonitoring.c</p3> I wrote a function called <code>getVolts(...)</code> as below :

      <pre class="brush:js;">
int getVolts(float *ret)
{
	int tmp_result;
 	struct modbus_c* bus = NULL;
	int i;
	u16 my_response_data[VOLTS_SIZE];
	char *response = (char *)my_response_data;
   modbus_init();
   bus = new_modbus_tcp_master_hostname( "192.168.10.100", 100, 0, NULL);

   if (bus == NULL)
   {
	  printf("Error - 1\n");
	  return 1;
   }

   adjust_pend_timeout(bus, 4000000); // 4 s, default is 2 s

   if ( modbus_open(bus,0,1) != 0)
   {
      modbus_destroy(bus);
	    printf("Error 2\n");
	    return 1;
   }
   else
   {
      printf("Modbus Opened \n");
   }



   tmp_result = read_holding_registers(
                 bus,   // modbus to use
                 1,    // device ID to ask
                 1100,     // start address 
                 24,     // datapoint count
                 my_response_data
                );

	  if (tmp_result == 0)
   	{
  		memcpy((void *)ret, (void *)my_response_data, 24);
   	}
   	else
   	{

      	printf("Hmm... error? : %s\n", modbus_error(tmp_result) );
    		return 1;
   	}

	  modbus_close(bus);
	  modbus_destroy(bus);
   	modbus_cleanup();
    return 0;
}
      </pre><br /><br />

      <br>
  </div>
  <!-- SHOW HIDE SEND 005  -->

  <!-- SHOW HIDE START 006  -->
  <style type="text/css">
    div[id=div-006] {
      display: none;
    }
      input[id=toggle-006]:checked ~ div[id=div-006] {
        display: block;
        }
    </style>
    
    <h2><label for="toggle-006">Existing scripts or additinal codes</label></h2>
    <input type="checkbox" id="toggle-006" style="display: none;">
    
    <div id="div-006">
        <tab></tab>
        Script appstart.sh from a new LU Unit. <br>
        <img alt="NO IMAGE" width="70%" src="img/img013.jpg"><br />
        <pre class="brush:js;">
root@SLU-IED:/apps$
root@SLU-IED:/apps$ cat appstart.sh
#!/bin/sh


echo "";
echo "";
echo "appstart script start!!!";
echo "";
echo "";

### QT Environment Variables ###
export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
export LD_LIBRARY_PATH="/lib:/apps:/usr/tslib/lib";
export QT_PLUGIN_PATH=/usr/lib/qt5/plugins;
export QT_QPA_PLATFORM=linuxfb;
export QT_QPA_PLUGIN="tslib";
export QT_QPA_FB_TSLIB="1";
export QT_QPA_FONTDIR="/usr/share/fonts/ttf";
export QT_QPA_GENERIC_PLUGINS=tslib:/dev/input/event0;
export QT_QPA_EVDEV_TOUCHSCREEN_PARAMETERS=/dev/input/event0;
export QWS_DISPLAY="LinuxFB:mmWidth=800:mmHeight=480";
export QWS_MOUSE_PROTO=tslib:$TSLIB_TSDEVICE
export LANG="ko_KR.UTF-8";


fbset -g 800 480 800 480 32;

### TSLIB Env Setting ####
export PS1="\u@\h:\w\$ "
export TSLIB_TSDEVICE=/dev/input/event0
export TSLIB_CONFFILE=/usr/tslib/etc/ts.conf
export TSLIB_CALIBFILE=/data/pointercal
export TSLIB_PLUGINDIR=/usr/tslib/lib/ts
export TSLIB_TSEVENTTYPE='INPUT'
export TSLIB_FBDEVICE='/dev/fb0'

#ethtool -s eth0 autoneg on speed 100 duplex full;
sleep 2;
ifconfig eth0 192.168.10.104 up;


cd /apps;
#./LU_MPU_FW;


#/bin/login -f root
/bin/sh
root@SLU-IED:/apps$
        </pre><br />

    <p3>I did not know how this script runs at startup in the new LU board. I searched for bashrc, /etc places.  </p3><br>


    </div>

  <!-- SHOW HIDE END 006  -->

<!--   -->

</div>

<!--
<pre class="brush:js;">
</pre><br /><br />
-->  
</body>
</html>
